<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question {{ question_number }} - AI Oral Exam Grader</title>
    <link rel="icon" type="image/png" href="/static/assets/depaul-shield.png">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/static/bluevox.css">
    <style>
        .timer-container {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(2, 10, 28, 0.85);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(70, 170, 255, 0.6);
            border-radius: 12px;
            padding: 15px 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 18px rgba(70, 160, 255, 0.16);
            z-index: 1000;
            font-size: 18px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.95);
        }
        .timer-container.warning {
            border-color: rgba(251, 191, 36, 0.8);
            background: rgba(251, 191, 36, 0.15);
            animation: pulse 1s infinite;
        }
        .timer-container.critical {
            border-color: rgba(220, 38, 38, 0.8);
            background: rgba(220, 38, 38, 0.15);
            animation: pulse 0.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .timer-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        .timer-display {
            font-size: 24px;
            color: rgba(255, 255, 255, 0.95);
        }
        .timer-warning {
            margin-top: 10px;
            padding: 10px;
            background: rgba(251, 191, 36, 0.3);
            color: rgba(255, 255, 255, 0.95);
            border-radius: 6px;
            display: none;
            border: 1px solid rgba(251, 191, 36, 0.5);
        }
        .timer-warning.show {
            display: block;
        }
        .timer-warning.critical {
            background: rgba(220, 38, 38, 0.3);
            border-color: rgba(220, 38, 38, 0.5);
        }

        .exam-header {
            background: var(--bluevox-card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--bluevox-card-border);
            border-radius: 12px;
            padding: 25px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .exam-header h1 {
            margin: 0 0 15px 0;
            color: var(--bluevox-text);
            font-size: 1.8em;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(2, 10, 28, 0.4);
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid rgba(120, 175, 255, 0.2);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--bluevox-btn-top), var(--bluevox-btn-bot));
            transition: width 0.3s;
            box-shadow: 0 0 10px rgba(70, 160, 255, 0.4);
        }

        .context-box,
        .question-box,
        .rubric-box {
            background: rgba(2, 10, 28, 0.4);
            border: 1px solid rgba(120, 175, 255, 0.2);
            border-left: 4px solid rgba(70, 170, 255, 0.6);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .question-box {
            background: rgba(30, 110, 255, 0.1);
            border-left-color: rgba(70, 170, 255, 0.8);
        }

        .rubric-box {
            background: rgba(251, 191, 36, 0.1);
            border-left-color: rgba(251, 191, 36, 0.6);
        }

        .context-box h3,
        .question-box h2,
        .rubric-box h3 {
            margin-top: 0;
            color: var(--bluevox-text);
            font-size: 1.2em;
        }

        .context-box p,
        .question-box p,
        .rubric-box p {
            color: rgba(255, 255, 255, 0.85);
            line-height: 1.6;
            margin: 0;
        }

        .attachment-box {
            background: rgba(2, 10, 28, 0.4);
            border: 1px solid rgba(120, 175, 255, 0.2);
            border-left: 4px solid rgba(34, 197, 94, 0.6);
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 20px;
        }

        .attachment-box h3 {
            margin-top: 0;
            margin-bottom: 12px;
            color: var(--bluevox-text);
            font-size: 1.1em;
        }

        .attachment-box img {
            display: block;
            margin: 0 auto;
        }

        .attachment-box iframe {
            display: block;
        }

        .answer-form {
            margin-top: 20px;
        }

        .form-actions {
            margin-top: 20px;
            text-align: right;
        }
    </style>
</head>
<body class="bluevox">
    {% if is_timed and duration_hours is not none and duration_minutes is not none %}
    <div class="timer-container" id="timerContainer">
        <div class="timer-label">Time Remaining</div>
        <div class="timer-display" id="timerDisplay">--:--:--</div>
        <div class="timer-warning" id="timerWarning"></div>
    </div>
    {% endif %}
    
    <div class="bluevox-container">
        <div class="exam-header">
            <h1>Question {{ question_number }} of {{ total_questions }}</h1>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ (question_number / total_questions * 100) }}%"></div>
            </div>
        </div>
        
        <div class="bluevox-card">
            {% if question.context %}
            <div class="context-box">
                <h3>Context</h3>
                <p>{{ question.context }}</p>
            </div>
            {% endif %}
            
            <div class="question-box">
                <h2>Question</h2>
                <p>{{ question.question_text }}</p>
            </div>
            
            {% if question.rubric %}
            <div class="rubric-box">
                <h3>Grading Rubric</h3>
                <p>{{ question.rubric }}</p>
            </div>
            {% endif %}
            
            {% if question.attachment_filename %}
            <div class="attachment-box">
                <h3>Reference Image/File</h3>
                {% if question.attachment_filename.lower().endswith(('.png', '.jpg', '.jpeg', '.gif', '.webp', '.svg')) %}
                    {# Display image inline #}
                    <div style="margin-top: 12px; text-align: center;">
                        <img src="/static/{{ question.attachment_path }}" 
                             alt="{{ question.attachment_filename }}"
                             style="max-width: 100%; max-height: 500px; height: auto; border-radius: 8px; border: 1px solid rgba(120, 175, 255, 0.2); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);">
                    </div>
                {% elif question.attachment_filename.lower().endswith('.pdf') %}
                    {# Embed PDF viewer #}
                    <div style="margin-top: 12px; width: 100%; height: 600px; border-radius: 8px; border: 1px solid rgba(120, 175, 255, 0.2); overflow: hidden; background: rgba(255, 255, 255, 0.05);">
                        <iframe src="/static/{{ question.attachment_path }}#toolbar=0" 
                                style="width: 100%; height: 100%; border: none;"
                                title="{{ question.attachment_filename }}">
                            <p style="color: rgba(255, 255, 255, 0.7); padding: 20px;">
                                Your browser does not support PDFs. 
                                <a href="/static/{{ question.attachment_path }}" target="_blank" style="color: rgba(170, 220, 255, 0.9);">Click here to open the PDF</a>
                            </p>
                        </iframe>
                    </div>
                {% endif %}
            </div>
            {% endif %}
            
            <form method="post" action="/api/exam/{{ exam_id }}/answer" class="answer-form">
                <input type="hidden" name="question_id" value="{{ question.id }}">
                
                <div class="bluevox-form-group">
                    <label for="answer">Your Answer:</label>
                    <textarea 
                        id="answer" 
                        name="answer" 
                        rows="12" 
                        class="bluevox-textarea"
                        required 
                        placeholder="Type your answer here..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="bluevox-btn">Submit Answer</button>
                </div>
            </form>
        </div>
    </div>
    
    {% if is_timed and duration_hours is not none and duration_minutes is not none %}
    <script>
        (function() {
            // Simple approach: calculate end time from duration when page loads
            const durationHours = {{ duration_hours }};
            const durationMinutes = {{ duration_minutes }};
            const durationMs = (durationHours * 60 * 60 * 1000) + (durationMinutes * 60 * 1000);
            const startTime = new Date().getTime();
            const examEndTime = startTime + durationMs;
            
            const timerDisplay = document.getElementById('timerDisplay');
            const timerContainer = document.getElementById('timerContainer');
            const timerWarning = document.getElementById('timerWarning');
            let warned20Min = false;
            let warned2Min = false;
            
            function updateTimer() {
                const now = new Date().getTime();
                const timeLeft = examEndTime - now;
                
                if (timeLeft <= 0) {
                    // Time is up - auto-submit
                    timerDisplay.textContent = '00:00:00';
                    timerWarning.textContent = 'Time is up! Your exam will be submitted automatically.';
                    timerWarning.classList.add('show', 'critical');
                    timerContainer.classList.add('critical');
                    
                    // Auto-submit after 2 seconds
                    setTimeout(() => {
                        const form = document.querySelector('.answer-form');
                        if (form) {
                            // Submit current answer if any, otherwise just submit empty
                            const answerTextarea = document.getElementById('answer');
                            if (!answerTextarea.value.trim()) {
                                answerTextarea.value = '[No answer provided - time expired]';
                            }
                            form.submit();
                        }
                    }, 2000);
                    return;
                }
                
                // Calculate time components
                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                // Format display
                timerDisplay.textContent = 
                    String(hours).padStart(2, '0') + ':' +
                    String(minutes).padStart(2, '0') + ':' +
                    String(seconds).padStart(2, '0');
                
                // Update styling based on time remaining
                const minutesLeft = Math.floor(timeLeft / (1000 * 60));
                
                if (minutesLeft <= 2) {
                    // Less than 2 minutes - critical warning
                    timerContainer.classList.remove('warning');
                    timerContainer.classList.add('critical');
                    if (!warned2Min) {
                        warned2Min = true;
                        timerWarning.textContent = 'WARNING: Less than 2 minutes remaining!';
                        timerWarning.classList.add('show', 'critical');
                    }
                } else if (minutesLeft <= 20) {
                    // Less than 20 minutes - warning
                    timerContainer.classList.add('warning');
                    if (!warned20Min) {
                        warned20Min = true;
                        timerWarning.textContent = 'Warning: Less than 20 minutes remaining.';
                        timerWarning.classList.add('show');
                    }
                }
            }
            
            // Update timer every second
            updateTimer();
            setInterval(updateTimer, 1000);
        })();
    </script>
    {% endif %}
</body>
</html>

