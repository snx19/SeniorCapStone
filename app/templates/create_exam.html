<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Exam - DePaul BlueVox</title>
    <link rel="icon" type="image/png" href="/static/assets/depaul-shield.png">
    
    <!-- UI font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/static/bluevox.css">
    <style>
      :root {
        --page-text: rgba(255, 255, 255, 0.9);
        --muted: rgba(255, 255, 255, 0.7);
        --accent: rgba(120, 190, 255, 0.75);
        --accent-soft: rgba(90, 160, 255, 0.22);
        --panel-bg: rgba(2, 10, 28, 0.65);
        --panel-border: rgba(120, 175, 255, 0.3);
        --field-bg: rgba(2, 10, 28, 0.38);
        --field-border: rgba(120, 175, 255, 0.55);
        --field-border-focus: rgba(150, 210, 255, 0.85);
        --btn-primary: rgba(70, 150, 255, 0.92);
        --btn-primary-hover: rgba(90, 170, 255, 0.95);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      /* Global input/select/textarea styling to prevent white backgrounds */
      input[type="text"],
      input[type="email"],
      input[type="password"],
      input[type="number"],
      input[type="search"],
      select,
      textarea {
        background: var(--field-bg) !important;
        border: 1px solid var(--field-border) !important;
        color: rgba(255, 255, 255, 0.95) !important;
      }

      input[type="text"]:focus,
      input[type="email"]:focus,
      input[type="password"]:focus,
      input[type="number"]:focus,
      input[type="search"]:focus,
      select:focus,
      textarea:focus {
        outline: none !important;
        border-color: var(--field-border-focus) !important;
        box-shadow: 0 0 0 3px rgba(150, 210, 255, 0.15) !important;
      }

      input::placeholder,
      textarea::placeholder {
        color: rgba(255, 255, 255, 0.4) !important;
      }

      select option {
        background: rgba(2, 10, 28, 0.95) !important;
        color: rgba(255, 255, 255, 0.95) !important;
      }

      select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
      }

      body.bluevox-form {
        margin: 0;
        padding: 0;
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        color: var(--page-text);
        overflow-x: hidden;
        min-height: 100vh;
        background:
          radial-gradient(1100px 760px at 88% 55%, rgba(40, 165, 255, 0.34), rgba(0, 0, 0, 0) 62%),
          radial-gradient(900px 650px at 92% 60%, rgba(20, 120, 255, 0.20), rgba(0, 0, 0, 0) 62%),
          linear-gradient(90deg, #02040b, #031531 55%, #062f67);
        position: relative;
      }

      /* Dashboard Layout */
      .dashboard-layout {
        display: flex;
        min-height: 100vh;
        position: relative;
        z-index: 1;
        width: 100%;
        max-width: 100vw;
        overflow-x: hidden;
        box-sizing: border-box;
      }

      /* Sidebar Styles */
      .sidebar {
        width: 260px;
        min-width: 180px;
        max-width: 500px;
        background: rgba(2, 10, 28, 0.8);
        backdrop-filter: blur(12px);
        border-right: 1px solid rgba(120, 175, 255, 0.15);
        padding: 32px 24px;
        display: flex;
        flex-direction: column;
        position: fixed;
        left: 0;
        height: 100vh;
        overflow-y: auto;
        transition: width 0.2s ease, left 0.3s ease;
        z-index: 1000;
      }

      .sidebar.collapsed {
        left: -260px !important;
      }

      .sidebar-resize-handle {
        position: absolute;
        top: 0;
        right: 0;
        width: 4px;
        height: 100%;
        cursor: col-resize;
        background: transparent;
        z-index: 1001;
        transition: background 0.2s ease;
      }

      .sidebar-resize-handle:hover {
        background: rgba(120, 175, 255, 0.3);
      }

      .sidebar-resize-handle.dragging {
        background: rgba(120, 175, 255, 0.5);
      }

      /* Sidebar Tab */
      .sidebar-tab {
        position: fixed;
        top: 50%;
        transform: translateY(-50%);
        width: 24px;
        height: 80px;
        background: rgba(2, 10, 28, 0.9);
        border: 1px solid rgba(120, 175, 255, 0.3);
        border-left: none;
        border-radius: 0 8px 8px 0;
        cursor: pointer;
        z-index: 1001;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: left 0.3s ease, width 0.2s ease;
        backdrop-filter: blur(12px);
        left: 260px;
      }

      .sidebar-tab:hover {
        background: rgba(2, 10, 28, 0.95);
        border-color: rgba(120, 175, 255, 0.5);
        width: 28px;
      }

      .sidebar-tab.sidebar-visible {
        left: 260px;
      }

      .sidebar-tab-icon {
        color: rgba(255, 255, 255, 0.8);
        font-size: 16px;
        transition: transform 0.3s ease;
        user-select: none;
      }

      .sidebar-tab:hover .sidebar-tab-icon {
        color: rgba(255, 255, 255, 0.95);
      }

      .sidebar-tab.collapsed .sidebar-tab-icon {
        transform: rotate(180deg);
      }

      .sidebar-tab.collapsed {
        left: 0 !important;
      }


      .sidebar-resize-handle {
        position: absolute;
        top: 0;
        right: 0;
        width: 4px;
        height: 100%;
        cursor: col-resize;
        background: transparent;
        z-index: 1001;
        transition: background 0.2s ease;
      }

      .sidebar-resize-handle:hover {
        background: rgba(120, 175, 255, 0.3);
      }

      .sidebar-resize-handle.dragging {
        background: rgba(120, 175, 255, 0.5);
      }


      .sidebar-logo {
        margin-bottom: 48px;
        padding-bottom: 24px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      .sidebar-brand-row {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
      }

      .sidebar-depaul-logo {
        height: 32px;
        width: auto;
        filter: drop-shadow(0 0 8px rgba(90, 170, 255, 0.2));
      }

      .sidebar-divider {
        width: 1px;
        height: 28px;
        background: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 0.5), transparent);
        opacity: 0.7;
      }

      .sidebar-bluevox-text {
        font-family: "Marck Script", cursive;
        font-size: 32px;
        line-height: 1;
        color: rgba(205, 232, 255, 0.95);
        text-shadow:
          0 0 8px rgba(90, 170, 255, 0.2),
          0 0 16px rgba(30, 120, 255, 0.1);
        user-select: none;
      }

      .sidebar-shield {
        width: 48px;
        height: auto;
        margin-top: 6px;
        opacity: 0.95;
        filter: drop-shadow(0 0 8px rgba(90, 170, 255, 0.15));
      }

      .nav-menu {
        list-style: none;
        flex: 1;
      }

      .nav-item {
        margin-bottom: 4px;
      }

      .nav-link {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        color: rgba(255, 255, 255, 0.7);
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.2s ease;
        font-size: 14px;
        font-weight: 500;
      }

      .nav-link:hover {
        background: rgba(120, 175, 255, 0.15);
        color: rgba(255, 255, 255, 0.9);
      }

      .nav-link.active {
        background: rgba(70, 150, 255, 0.2);
        color: rgba(255, 255, 255, 0.95);
      }

      .nav-link::before {
        content: "";
        width: 3px;
        height: 0;
        background: var(--accent);
        border-radius: 0 2px 2px 0;
        margin-right: 0;
        transition: height 0.2s ease;
      }

      .nav-link.active::before {
        height: 20px;
        margin-right: 12px;
      }

      .sidebar-footer {
        margin-top: auto;
        padding-top: 20px;
        border-top: 1px solid var(--panel-border);
      }

      .logout-btn {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        color: rgba(255, 255, 255, 0.7);
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.2s ease;
        font-size: 14px;
        font-weight: 500;
        width: 100%;
        background: none;
        border: none;
        cursor: pointer;
      }

      .logout-btn:hover {
        background: rgba(220, 38, 38, 0.2);
        color: rgba(255, 255, 255, 0.9);
      }

      /* Main Content */
      .main-content {
        flex: 1 1 0;
        margin-left: 260px;
        padding: 32px 40px;
        min-width: 0;
        max-width: calc(100vw - 260px);
        width: calc(100vw - 260px);
        overflow-x: hidden !important;
        overflow-y: auto;
        box-sizing: border-box;
        position: relative;
        flex-shrink: 1;
        transition: margin-left 0.2s ease, width 0.2s ease, max-width 0.2s ease;
      }


      body.bluevox-form::before {
        content: "";
        position: fixed;
        inset: 0;
        background-image:
          radial-gradient(1px 1px at 12% 18%, rgba(255, 255, 255, 0.75) 50%, transparent 52%),
          radial-gradient(1px 1px at 18% 62%, rgba(255, 255, 255, 0.6) 50%, transparent 52%),
          radial-gradient(1px 1px at 28% 78%, rgba(255, 255, 255, 0.55) 50%, transparent 52%),
          radial-gradient(1px 1px at 33% 35%, rgba(255, 255, 255, 0.55) 50%, transparent 52%),
          radial-gradient(1px 1px at 46% 22%, rgba(255, 255, 255, 0.5) 50%, transparent 52%),
          radial-gradient(1px 1px at 52% 66%, rgba(255, 255, 255, 0.6) 50%, transparent 52%),
          radial-gradient(1px 1px at 63% 44%, rgba(255, 255, 255, 0.6) 50%, transparent 52%),
          radial-gradient(1px 1px at 71% 77%, rgba(255, 255, 255, 0.55) 50%, transparent 52%),
          radial-gradient(1px 1px at 79% 16%, rgba(255, 255, 255, 0.6) 50%, transparent 52%),
          radial-gradient(1px 1px at 86% 58%, rgba(255, 255, 255, 0.7) 50%, transparent 52%),
          radial-gradient(1px 1px at 92% 32%, rgba(255, 255, 255, 0.55) 50%, transparent 52%),
          radial-gradient(1px 1px at 6% 82%, rgba(255, 255, 255, 0.5) 50%, transparent 52%);
        opacity: 0.55;
        pointer-events: none;
        z-index: 0;
      }

      .form-container {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
        padding: 40px 20px;
        position: relative;
        z-index: 1;
      }

      .form-card {
        width: 100%;
        max-width: 900px;
        background: var(--panel-bg);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(120, 175, 255, 0.15);
        border-radius: 12px;
        padding: 40px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      }

      .form-header {
        margin-bottom: 32px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .form-header h1 {
        font-size: 28px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.95);
        margin-bottom: 8px;
        letter-spacing: -0.5px;
      }

      .back-link {
        color: rgba(170, 220, 255, 0.8);
        text-decoration: none;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: color 0.2s;
        margin-bottom: 12px;
      }

      .back-link:hover {
        color: rgba(220, 245, 255, 0.95);
      }

      .form-group {
        margin-bottom: 24px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 500;
        font-size: 14px;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px 16px;
        background: var(--field-bg);
        border: 1px solid var(--field-border);
        border-radius: 8px;
        color: rgba(255, 255, 255, 0.95);
        font-size: 14px;
        font-family: Inter, sans-serif;
        transition: all 0.2s ease;
        box-sizing: border-box;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--field-border-focus);
        box-shadow: 0 0 0 3px rgba(150, 210, 255, 0.15);
      }

      .form-group input::placeholder,
      .form-group textarea::placeholder {
        color: rgba(255, 255, 255, 0.4);
      }

      .form-group textarea {
        min-height: 200px;
        resize: vertical;
        line-height: 1.5;
      }

      .course-select-group {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 15px;
      }
      
      .section-checkbox {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        transition: all 0.2s ease;
        cursor: pointer;
      }
      
      .section-checkbox:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(120, 175, 255, 0.4);
      }
      
      .section-checkbox input[type="checkbox"] {
        margin-right: 10px;
        width: 18px;
        height: 18px;
        cursor: pointer;
        flex-shrink: 0;
        accent-color: var(--accent);
      }
      
      .section-checkbox label {
        margin: 0;
        cursor: pointer;
        font-weight: normal;
        flex: 1;
        user-select: none;
      }

      .sections-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 10px;
        margin-top: 8px;
        max-height: 200px;
        overflow-y: auto;
        padding: 4px;
      }

      .info-text {
        color: rgba(255, 255, 255, 0.5);
        font-size: 12px;
        margin-top: 6px;
        line-height: 1.4;
      }

      .grid-2-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .radio-group {
        display: flex;
        gap: 20px;
        margin-bottom: 12px;
      }

      .radio-option {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }

      .radio-option input[type="radio"] {
        width: 18px;
        height: 18px;
        accent-color: var(--accent);
        cursor: pointer;
      }

      .radio-option label {
        margin: 0;
        cursor: pointer;
        font-weight: normal;
      }

      .duration-fields {
        margin-top: 15px;
        padding: 16px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        display: none;
      }

      .duration-fields.active {
        display: block;
      }

      .duration-controls {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .duration-controls select {
        padding: 8px 12px;
        width: auto;
      }

      .duration-controls label {
        margin-left: 5px;
        margin-bottom: 0;
        font-weight: normal;
      }

      .button-group {
        display: flex;
        gap: 12px;
        margin-top: 32px;
      }

      .btn-primary {
        background: linear-gradient(180deg, var(--btn-primary), rgba(35, 105, 245, 0.88));
        border: 1px solid rgba(170, 220, 255, 0.5);
        color: rgba(255, 255, 255, 0.95);
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        flex: 1;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .btn-primary:hover:not(:disabled) {
        background: linear-gradient(180deg, var(--btn-primary-hover), rgba(45, 115, 255, 0.92));
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
      }

      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.9);
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        flex: 1;
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
      }

      .error-message {
        background: rgba(220, 38, 38, 0.2);
        border: 1px solid rgba(220, 38, 38, 0.4);
        color: rgba(255, 255, 255, 0.95);
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
      }

      .required-indicator {
        color: rgba(255, 100, 100, 0.9);
        margin-left: 4px;
      }

      @media (max-width: 768px) {
        .form-card {
          padding: 30px 24px;
        }

        .course-select-group {
          grid-template-columns: 1fr;
        }

        .grid-2-col {
          grid-template-columns: 1fr;
        }

        .button-group {
          flex-direction: column;
        }
      }
    </style>
</head>
<body class="bluevox-form">
    <div class="dashboard-layout">
        <!-- Sidebar Tab -->
        <div class="sidebar-tab sidebar-visible" id="sidebar-tab">
            <span class="sidebar-tab-icon" id="sidebar-tab-icon">◀</span>
        </div>
        
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-resize-handle" id="sidebar-resize-handle"></div>
            <div class="sidebar-logo">
                <div class="sidebar-brand-row">
                    <img class="sidebar-depaul-logo" src="/static/assets/depaul-logo.png" alt="DePaul" />
                    <div class="sidebar-divider" aria-hidden="true"></div>
                    <div class="sidebar-bluevox-text">BlueVox</div>
                </div>
                <img class="sidebar-shield" src="/static/assets/depaul-shield.png" alt="DePaul Shield" />
            </div>
            
            <nav class="nav-menu">
                <ul style="list-style: none; padding: 0;">
                    <li class="nav-item">
                        <a href="/teacher/dashboard" class="nav-link">
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/teacher/manage-students" class="nav-link">
                            Manage Students
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/teacher/exams" class="nav-link">
                            Exams
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/teacher/analytics" class="nav-link">
                            Analytics
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/teacher/notifications" class="nav-link">
                            Notifications
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/teacher/settings" class="nav-link">
                            Settings
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <a href="/" class="logout-btn">
                    Logout
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
    <div class="form-container">
        <div class="form-card">
            <div class="form-header">
                <h1>Create New Exam</h1>
            </div>
            
            {% if error %}
            <div class="bluevox-message bluevox-message-error">
                {{ error }}
            </div>
            {% endif %}
            
            <form method="post" action="/teacher/create-exam" id="create-exam-form">
                <!-- Course Selection -->
                <div class="form-group">
                    <label>Course / Section / Quarter</label>
                    <div class="course-select-group">
                        <div>
                            <label for="course_number" style="margin-bottom: 8px; display: block;">Course Number</label>
                            <select id="course_number" name="course_number" required onchange="updateSections()">
                                <option value="">Select Course</option>
                                {% for course_num in unique_course_numbers %}
                                <option value="{{ course_num }}">{{ course_num }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div style="grid-column: 2; grid-row: 1 / 3;">
                            <label style="margin-bottom: 8px; display: block;">Sections (select all that apply)</label>
                            <div id="sections-container" class="sections-container">
                                <!-- Sections will be populated here as checkboxes -->
                            </div>
                            <p class="info-text" style="margin-top: 10px;">Select one or more sections from the same quarter/year</p>
                        </div>
                        <div style="grid-column: 1; grid-row: 2;">
                            <label for="quarter_year" style="margin-bottom: 8px; display: block;">Quarter / Year</label>
                            <select id="quarter_year" name="quarter_year" required>
                                <option value="">Select Quarter/Year</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Exam Name -->
                <div class="form-group">
                    <label for="exam_name">Exam Name</label>
                    <input 
                        type="text" 
                        id="exam_name" 
                        name="exam_name" 
                        class="bluevox-input"
                        required 
                        placeholder="e.g. Midterm"
                        autocomplete="off"
                    >
                </div>
                
                <!-- Topic and Number of Questions -->
                <div class="form-group grid-2-col">
                    <div>
                        <label for="exam_topic">Exam Topic<span class="required-indicator">*</span></label>
                        <input 
                            type="text" 
                            id="exam_topic" 
                            name="exam_topic" 
                            class="bluevox-input"
                            required 
                            placeholder="e.g. Data Structures and Algorithms"
                            autocomplete="off"
                        >
                        <p class="info-text">The main topic or subject area for the exam</p>
                    </div>
                    <div>
                        <label for="num_questions">Number of Questions<span class="required-indicator">*</span></label>
                        <input 
                            type="number" 
                            id="num_questions" 
                            name="num_questions" 
                            class="bluevox-input"
                            required 
                            min="1" 
                            max="30"
                            value="5"
                            autocomplete="off"
                        >
                        <p class="info-text">How many questions should the exam contain (1-30)</p>
                    </div>
                </div>
                
                <!-- Exam Difficulty -->
                <div class="form-group">
                    <label for="exam_difficulty">Exam Difficulty<span class="required-indicator">*</span></label>
                    <select id="exam_difficulty" name="exam_difficulty" required>
                        <option value="">Select Difficulty Level</option>
                        <optgroup label="High School">
                            <option value="High School - Freshman">High School - Freshman</option>
                            <option value="High School - Sophomore">High School - Sophomore</option>
                            <option value="High School - Junior">High School - Junior</option>
                            <option value="High School - Senior">High School - Senior</option>
                        </optgroup>
                        <optgroup label="Undergraduate">
                            <option value="Undergraduate - Freshman">Undergraduate - Freshman</option>
                            <option value="Undergraduate - Sophomore">Undergraduate - Sophomore</option>
                            <option value="Undergraduate - Junior">Undergraduate - Junior</option>
                            <option value="Undergraduate - Senior" selected>Undergraduate - Senior</option>
                        </optgroup>
                        <optgroup label="Graduate">
                            <option value="Graduate">Graduate</option>
                            <option value="PhD">PhD</option>
                        </optgroup>
                    </select>
                    <p class="info-text">The expected difficulty level (by school year / grade). This is passed to the AI so questions are appropriate for that level.</p>
                </div>
                
                <!-- Timed Exam Selection -->
                <div class="form-group">
                    <label>Timed Exam</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="timed_no" name="is_timed" value="no" checked onchange="toggleDurationFields()">
                            <label for="timed_no">No</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="timed_yes" name="is_timed" value="yes" onchange="toggleDurationFields()">
                            <label for="timed_yes">Yes</label>
                        </div>
                    </div>
                    <div id="duration-fields" class="duration-fields">
                        <label style="margin-bottom: 8px; display: block;">Exam Duration</label>
                        <div class="duration-controls">
                            <div>
                                <select id="duration_hours" name="duration_hours">
                                    <option value="0">0</option>
                                    <option value="1">1</option>
                                    <option value="2" selected>2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                </select>
                                <label for="duration_hours">hours</label>
                            </div>
                            <div>
                                <select id="duration_minutes" name="duration_minutes">
                                    <option value="0" selected>0</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                                <label for="duration_minutes">minutes</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Details Input -->
                <div class="form-group">
                    <label for="llm_prompt">Additional Details (Optional but Recommended)</label>
                    <textarea 
                        id="llm_prompt" 
                        name="llm_prompt" 
                        class="bluevox-textarea"
                        placeholder="Please enter rubric, grading criteria, specific sub-topics, questions you want included, expected answers, or any further expectations. The AI can create a good exam from just the topic, but additional details will result in a stronger, more tailored exam."
                    ></textarea>
                    <p class="info-text">Provide additional context such as: rubric, grading criteria, specific sub-topics, questions you want included, expected answers, or any other expectations. This is optional - the AI can create a good exam from just the topic, but more details will result in a better exam.</p>
                </div>
                
                <div class="button-group">
                    <a href="/teacher/dashboard" class="bluevox-btn bluevox-btn-secondary" style="text-align: center;" onclick="return confirmCancel(event);">Cancel</a>
                    <button type="submit" class="bluevox-btn" id="generate-btn" style="flex: 1;">Generate and Review</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Store courses data for JavaScript
        const coursesData = [
            {% for course in all_courses %}
            {
                course_number: "{{ course.course_number }}",
                section: "{{ course.section }}",
                quarter_year: "{{ course.quarter_year }}"
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        function updateSections() {
            const courseSelect = document.getElementById('course_number');
            const sectionsContainer = document.getElementById('sections-container');
            const quarterSelect = document.getElementById('quarter_year');
            
            const selectedCourse = courseSelect.value;
            
            // Clear sections and quarters
            sectionsContainer.innerHTML = '';
            quarterSelect.innerHTML = '<option value="">Select Quarter/Year</option>';
            
            if (!selectedCourse) return;
            
            // Get unique sections and quarter/years for this course
            const sectionsByQuarter = {};
            const quarterYears = new Set();
            
            coursesData.forEach(course => {
                if (course.course_number === selectedCourse) {
                    quarterYears.add(course.quarter_year);
                    // Group sections by quarter/year
                    if (!sectionsByQuarter[course.quarter_year]) {
                        sectionsByQuarter[course.quarter_year] = new Set();
                    }
                    sectionsByQuarter[course.quarter_year].add(course.section);
                }
            });
            
            // Create checkboxes for each section
            Object.keys(sectionsByQuarter).sort().forEach(quarter => {
                Array.from(sectionsByQuarter[quarter]).sort().forEach(section => {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'section-checkbox';
                    checkboxDiv.innerHTML = `
                        <input type="checkbox" id="section_${section}_${quarter}" name="sections[]" value="${section}" data-quarter="${quarter}">
                        <label for="section_${section}_${quarter}">Section ${section}</label>
                    `;
                    sectionsContainer.appendChild(checkboxDiv);
                });
            });
            
            // Populate quarter/years dropdown
            Array.from(quarterYears).sort().forEach(qy => {
                const option = document.createElement('option');
                option.value = qy;
                option.textContent = qy;
                quarterSelect.appendChild(option);
            });
            
            // Auto-select quarter/year if only one option
            if (quarterYears.size === 1) {
                quarterSelect.value = Array.from(quarterYears)[0];
            }
            
            // Update quarter when section checkbox changes (ensure consistency)
            // Track selected quarter to ensure all sections are from the same quarter
            let selectedQuarter = null;
            document.querySelectorAll('input[name="sections[]"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const quarter = this.getAttribute('data-quarter');
                    
                    if (this.checked) {
                        // If no quarter selected yet, set it
                        if (!selectedQuarter) {
                            selectedQuarter = quarter;
                            quarterSelect.value = quarter;
                            // Disable checkboxes from other quarters
                            document.querySelectorAll('input[name="sections[]"]').forEach(cb => {
                                if (cb.getAttribute('data-quarter') !== quarter) {
                                    cb.disabled = true;
                                    cb.parentElement.style.opacity = '0.5';
                                }
                            });
                        } else if (quarter !== selectedQuarter) {
                            // Trying to select section from different quarter - uncheck it
                            this.checked = false;
                            alert(`Please select sections from the same quarter/year (${selectedQuarter}).`);
                        }
                    } else {
                        // Unchecked - check if any other sections are still selected
                        const checkedBoxes = document.querySelectorAll('input[name="sections[]"]:checked');
                        if (checkedBoxes.length === 0) {
                            // No sections selected, reset everything
                            selectedQuarter = null;
                            quarterSelect.value = '';
                            document.querySelectorAll('input[name="sections[]"]').forEach(cb => {
                                cb.disabled = false;
                                cb.parentElement.style.opacity = '1';
                            });
                        }
                    }
                });
            });
        }

        // Update sections when course changes
        document.getElementById('course_number').addEventListener('change', updateSections);
        
        // Toggle duration fields based on timed selection
        function toggleDurationFields() {
            const isTimedRadio = document.querySelector('input[name="is_timed"]:checked');
            if (!isTimedRadio) return;
            
            const isTimed = isTimedRadio.value === 'yes';
            const durationFields = document.getElementById('duration-fields');
            if (durationFields) {
                if (isTimed) {
                    durationFields.classList.add('active');
                } else {
                    durationFields.classList.remove('active');
                }
                
                // Make duration required if timed
                const hoursSelect = document.getElementById('duration_hours');
                const minutesSelect = document.getElementById('duration_minutes');
                if (hoursSelect) hoursSelect.required = isTimed;
                if (minutesSelect) minutesSelect.required = isTimed;
            }
        }
        
        // Make function globally accessible
        window.toggleDurationFields = toggleDurationFields;
        
        // Initialize duration fields visibility on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', toggleDurationFields);
        } else {
            // DOM already loaded
            toggleDurationFields();
        }
        
        // Validate at least one section is selected on form submit
        document.getElementById('create-exam-form').addEventListener('submit', function(e) {
            console.log('Form submit event triggered');
            const checkedSections = document.querySelectorAll('input[name="sections[]"]:checked');
            console.log('Checked sections:', checkedSections.length);
            
            if (checkedSections.length === 0) {
                e.preventDefault();
                alert('Please select at least one section.');
                return false;
            }
            
            // Validate duration if timed
            const isTimed = document.querySelector('input[name="is_timed"]:checked').value === 'yes';
            if (isTimed) {
                const hours = parseInt(document.getElementById('duration_hours').value) || 0;
                const minutes = parseInt(document.getElementById('duration_minutes').value) || 0;
                if (hours === 0 && minutes === 0) {
                    e.preventDefault();
                    alert('Please select a duration for the timed exam.');
                    return false;
                }
            }
            
            // Log form data being submitted
            const formData = new FormData(this);
            console.log('Form data:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: ${value}`);
            }
        });

        // Track form changes
        let formChanged = false;
        const form = document.getElementById('create-exam-form');
        if (form) {
            const formInputs = form.querySelectorAll('input, select, textarea');
            formInputs.forEach(input => {
                input.addEventListener('change', function() {
                    formChanged = true;
                });
                input.addEventListener('input', function() {
                    formChanged = true;
                });
            });
        }

        // Cancel button with warning
        function confirmCancel(e) {
            if (formChanged) {
                if (!confirm('You have entered information. Are you sure you want to cancel? All entered data will be lost.')) {
                    e.preventDefault();
                    return false;
                }
            }
            return true;
        }

        // Warn before leaving page if form has changes
        window.addEventListener('beforeunload', function(e) {
            if (formChanged) {
                e.preventDefault();
                e.returnValue = 'You have entered information. Are you sure you want to leave? All entered data will be lost.';
                return e.returnValue;
            }
        });
    </script>
        </main>
    </div>

    <script>
        // Sidebar Resize and Toggle Functionality
        (function() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            const resizeHandle = document.getElementById('sidebar-resize-handle');
            const sidebarTab = document.getElementById('sidebar-tab');
            
            if (!sidebar || !mainContent || !resizeHandle || !sidebarTab) return;
            
            // Load saved sidebar state
            const savedWidth = localStorage.getItem('sidebarWidth');
            const savedVisibility = localStorage.getItem('sidebarVisible');
            
            // Define helper functions first
            function updateMainContentMargin(sidebarWidth) {
                if (!sidebar.classList.contains('collapsed')) {
                    mainContent.style.marginLeft = sidebarWidth + 'px';
                    mainContent.style.width = `calc(100vw - ${sidebarWidth}px)`;
                    mainContent.style.maxWidth = `calc(100vw - ${sidebarWidth}px)`;
                }
            }
            
            function updateTabPosition(sidebarWidth) {
                if (!sidebar.classList.contains('collapsed')) {
                    sidebarTab.style.left = sidebarWidth + 'px';
                }
            }
            
            const sidebarTabIcon = document.getElementById('sidebar-tab-icon');
            
            if (savedWidth) {
                sidebar.style.width = savedWidth + 'px';
                updateMainContentMargin(parseInt(savedWidth));
                updateTabPosition(parseInt(savedWidth));
            }
            
            if (savedVisibility === 'false') {
                // Initialize hidden state
                const sidebarWidth = parseInt(window.getComputedStyle(sidebar).width, 10);
                sidebar.style.left = `-${sidebarWidth}px`;
                sidebar.classList.add('collapsed');
                mainContent.classList.add('sidebar-hidden');
                sidebarTab.classList.add('collapsed');
                sidebarTab.classList.remove('sidebar-visible');
                sidebarTab.style.left = '0';
                if (sidebarTabIcon) sidebarTabIcon.textContent = '▶';
                // Expand main content to full width
                mainContent.style.marginLeft = '0';
                mainContent.style.width = '100vw';
                mainContent.style.maxWidth = '100vw';
            }
            
            // Tab toggle functionality
            let isDraggingTab = false;
            let dragStartX = 0;
            let dragStartLeft = 0;
            let hasMoved = false;
            
            sidebarTab.addEventListener('mousedown', function(e) {
                isDraggingTab = true;
                hasMoved = false;
                dragStartX = e.clientX;
                dragStartLeft = sidebar.classList.contains('collapsed') ? 0 : parseInt(window.getComputedStyle(sidebar).width, 10);
                document.body.style.cursor = 'grabbing';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isDraggingTab) return;
                
                const deltaX = e.clientX - dragStartX;
                
                // Check if user has moved the mouse significantly
                if (Math.abs(deltaX) > 5) {
                    hasMoved = true;
                }
                
                const sidebarWidth = parseInt(window.getComputedStyle(sidebar).width, 10);
                const newLeft = dragStartLeft + deltaX;
                
                // Update tab position during drag for visual feedback
                if (sidebar.classList.contains('collapsed')) {
                    // When hidden, tab can only move right
                    sidebarTab.style.left = Math.max(0, newLeft) + 'px';
                } else {
                    // When visible, tab can only move left
                    sidebarTab.style.left = Math.min(sidebarWidth, newLeft) + 'px';
                }
            });
            
            document.addEventListener('mouseup', function(e) {
                if (isDraggingTab) {
                    const deltaX = e.clientX - dragStartX;
                    
                    // If user dragged significantly, toggle based on direction
                    if (hasMoved && Math.abs(deltaX) > 20) {
                        if (deltaX < -20 && !sidebar.classList.contains('collapsed')) {
                            // Dragged left - hide sidebar
                            hideSidebar();
                        } else if (deltaX > 20 && sidebar.classList.contains('collapsed')) {
                            // Dragged right - show sidebar
                            showSidebar();
                        } else {
                            // Reset tab position
                            resetTabPosition();
                        }
                    } else if (!hasMoved) {
                        // Simple click - toggle
                        if (sidebar.classList.contains('collapsed')) {
                            showSidebar();
                        } else {
                            hideSidebar();
                        }
                    } else {
                        // Small movement - reset position
                        resetTabPosition();
                    }
                    
                    isDraggingTab = false;
                    hasMoved = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
            
            function resetTabPosition() {
                const isHidden = sidebar.classList.contains('collapsed');
                if (isHidden) {
                    sidebarTab.style.left = '0';
                } else {
                    const sidebarWidth = parseInt(window.getComputedStyle(sidebar).width, 10);
                    sidebarTab.style.left = sidebarWidth + 'px';
                }
            }
            
            const sidebarTabIcon = document.getElementById('sidebar-tab-icon');
            
            function hideSidebar() {
                const sidebarWidth = parseInt(window.getComputedStyle(sidebar).width, 10);
                sidebar.style.left = `-${sidebarWidth}px`;
                sidebar.classList.add('collapsed');
                mainContent.classList.add('sidebar-hidden');
                sidebarTab.classList.add('collapsed');
                sidebarTab.classList.remove('sidebar-visible');
                sidebarTab.style.left = '0';
                if (sidebarTabIcon) sidebarTabIcon.textContent = '▶';
                // Expand main content to full width
                mainContent.style.marginLeft = '0';
                mainContent.style.width = '100vw';
                mainContent.style.maxWidth = '100vw';
                localStorage.setItem('sidebarVisible', 'false');
            }
            
            function showSidebar() {
                const sidebarWidth = parseInt(window.getComputedStyle(sidebar).width, 10);
                sidebar.style.left = '0';
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('sidebar-hidden');
                sidebarTab.classList.remove('collapsed');
                sidebarTab.classList.add('sidebar-visible');
                sidebarTab.style.left = sidebarWidth + 'px';
                if (sidebarTabIcon) sidebarTabIcon.textContent = '◀';
                // Adjust main content to account for sidebar
                updateMainContentMargin(sidebarWidth);
                localStorage.setItem('sidebarVisible', 'true');
            }
            
            function toggleSidebar() {
                if (sidebar.classList.contains('collapsed')) {
                    showSidebar();
                } else {
                    hideSidebar();
                }
            }
            
            // Resize functionality
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;
            
            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startWidth = parseInt(window.getComputedStyle(sidebar).width, 10);
                resizeHandle.classList.add('dragging');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const width = startWidth + (e.clientX - startX);
                const minWidth = 180;
                const maxWidth = 500;
                
                if (width >= minWidth && width <= maxWidth) {
                    sidebar.style.width = width + 'px';
                    updateMainContentMargin(width);
                    updateTabPosition(width);
                }
            });
            
            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    resizeHandle.classList.remove('dragging');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    
                    // Save width to localStorage
                    const currentWidth = parseInt(window.getComputedStyle(sidebar).width, 10);
                    localStorage.setItem('sidebarWidth', currentWidth);
                }
            });
            
            // Initialize tab position
            if (!sidebar.classList.contains('collapsed')) {
                const sidebarWidth = parseInt(window.getComputedStyle(sidebar).width, 10);
                sidebarTab.style.left = sidebarWidth + 'px';
            }
        })();
    </script>
</body>
</html>
